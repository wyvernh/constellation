#!/usr/bin/env bash

set -euo pipefail

if [ "$(id -u)" -eq 0 ]; then
    echo "ERROR! $(basename "$0") should be run as a regular user"
    exit 1
fi

cd "$HOME"

ping -q -c1 google.com &>/dev/null && echo "online! Proceeding with the installation..." || nmtui

if [ ! -d "$HOME/mhguix/" ]; then
    CHANNEL_NAME=mhguix
    CHANNEL_INFO=$(guix describe --format=channels | grep -A 4 "'$CHANNEL_NAME)")
    CHANNEL_URL=$(echo "$CHANNEL_INFO" | awk -F'"' '/(url)/{print $2}')
    CHANNEL_COMMIT=$(echo "$CHANNEL_INFO" | awk -F'"' '/(commit)/{print $6}')
    git clone "$CHANNEL_URL"
    cd "$HOME/mhguix"
    git checkout "$CHANNEL_COMMIT"
    cd "$HOME"
fi

gum style --border normal --margin "1" --padding "1 2" "Choose a system to install or select `New` in order to create a new system."

SYSTEM="$(gum choose $(basename -s .scm $(find "$HOME/mhguix/wyvernh/systems/" -mindepth 1 -maxdepth 1 -type f -iname '*.scm' -printf "%f\n"); printf "New"))"

if [[ "$SYSTEM" == "New" ]]; then
    gum style --border normal --margin "1" --padding "1 2" "Choose a system name"
    SYSTEM="$(gum input --placeholder "system name")"
fi


if [ ! -f "$HOME/mhguix/wyvernh/systems/$SYSTEM.scm" ]; then
    cat > "$HOME/mhguix/wyvernh/systems/$SYSTEM.scm" <<EOF
(define-module (wyvernh systems $SYSTEM)
  #:use-module (wyvernh modules home)
  #:use-module (wyvernh modules system)
  #:export (home os disk))

(home-config)

(system-config)
EOF

    gum style --border normal --margin "1" --padding "1 2" "Edit the system config file."
    gum input --placeholder "Press Enter to continue" >/dev/null
    vim "$HOME/mhguix/wyvernh/systems/$SYSTEM.scm"

    cd "$HOME/mhguix" && git add . && cd "$HOME"
fi

gum style --border normal --margin "1" --padding "1 2" "Formatting the drive is destructive!"
if gum confirm "Are you sure you want to continue?"; then
    echo "Proceeding..."
else
    echo "Aborting."
    exit 1
fi

mhdisk "$HOME/mhguix/systems/$SYSTEM.scm"
mhdisk-mount /mnt "$HOME/mhguix/systems/$SYSTEM.scm"

herd start cow-store /mnt

sudo guix system init -L "$HOME/mhguix" -e "(@ (wyvernh systems $SYSTEM) os)" /mnt

target_user="$(ls /mnt/home | head -n1)"
if [ -z "$target_user" ]; then
    echo "No user directories found in /mnt/home"
    echo "The config file for $SYSTEM will not be copied to the new system"
fi
sudo cp -r "$HOME/mhguix" "/mnt/home/$target_user/"

echo "rebooting..."; sleep 3; reboot
